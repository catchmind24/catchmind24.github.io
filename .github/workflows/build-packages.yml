name: Build Packages

on:
  push:
    branches: [ main ]
    paths:
      - 'debs/**'
      - 'scripts/index.sh'
      - '.github/workflows/build-packages.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Install dpkg-dev
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: Make index
        run: |
          chmod +x scripts/index.sh
          ./scripts/index.sh

      - name: Verify generated files
        run: |
          echo "ğŸ“¦ ìƒì„±ëœ íŒŒì¼ í™•ì¸:"
          ls -lh Packages Packages.gz Release 2>/dev/null || {
            echo "âŒ í•„ìˆ˜ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          }
          echo "âœ… ëª¨ë“  íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo ""
          echo "ğŸ“Š Packages íŒŒì¼ ì •ë³´:"
          wc -l Packages

      - name: Commit & push index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # íŒŒì¼ ì¶”ê°€ (ì—ëŸ¬ ë°œìƒì‹œ ì¤‘ë‹¨)
          git add Packages Packages.gz Release
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          if ! git diff --cached --quiet; then
            git commit -m "Update repo index [$(date -u +%Y-%m-%d_%H:%M:%S)]"
            
            # í‘¸ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
            for i in {1..3}; do
              if git push; then
                echo "âœ… í‘¸ì‹œ ì„±ê³µ"
                break
              else
                echo "âš ï¸ í‘¸ì‹œ ì‹¤íŒ¨, ì¬ì‹œë„ $i/3"
                sleep 2
                git pull --rebase
              fi
            done
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi

      - name: Trigger Pages rebuild
        run: |
          echo "ğŸ”„ GitHub Pages ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ë”ë¯¸ ì»¤ë°‹"
          # Pages ê°•ì œ ì¬ë¹Œë“œë¥¼ ìœ„í•œ ë°©ë²•
          git commit --allow-empty -m "Trigger Pages rebuild [skip ci]"
          git push || echo "ë”ë¯¸ ì»¤ë°‹ í‘¸ì‹œ ì‹¤íŒ¨ (ë¬´ì‹œ ê°€ëŠ¥)"
